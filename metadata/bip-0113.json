{
  "BIP": "113",
  "Layer": "Consensus (soft fork)",
  "Title": "Median time-past as endpoint for lock-time calculations",
  "Author": "Thomas Kerin <me@thomaskerin.io>",
  "Comments-Summary": "No comments yet.",
  "Comments-URI": "https://github.com/bitcoin/bips/wiki/Comments:BIP-0113",
  "Status": "Final",
  "Type": "Standards Track",
  "Created": "2015-08-10",
  "License": "PD",
  "sections": [
    {
      "header": "Abstract",
      "content": "This BIP is a proposal to redefine the semantics used in determining a\ntime-locked transaction\\'s eligibility for inclusion in a block. The\nmedian of the last 11 blocks is used instead of the block\\'s timestamp,\nensuring that it increases monotonically with each block."
    },
    {
      "header": "Motivation",
      "content": "At present, transactions are excluded from inclusion in a block if the\npresent time or block height is less than or equal to that specified in\nthe locktime. Since the consensus rules do not mandate strict ordering\nof block timestamps, this has the unfortunate outcome of creating a\nperverse incentive for miners to lie about the time of their blocks in\norder to collect more fees by including transactions that by wall clock\ndetermination have not yet matured.\n\nThis BIP proposes comparing the locktime against the median of the past\n11 block\\'s timestamps, rather than the timestamp of the block including\nthe transaction. Existing consensus rules guarantee this value to\nmonotonically advance, thereby removing the capability for miners to\nclaim more transaction fees by lying about the timestamps of their\nblock.\n\nThis proposal seeks to ensure reliable behaviour in locktime\ncalculations as required by BIP65 (CHECKLOCKTIMEVERIFY) and matching the\nbehavior of BIP68 (sequence numbers) and BIP112 (CHECKSEQUENCEVERIFY)."
    },
    {
      "header": "Specification",
      "content": "The values for transaction locktime remain unchanged. The difference is\nonly in the calculation determining whether a transaction can be\nincluded. Instead of an unreliable timestamp, the following function is\nused to determine the current block time for the purpose of checking\nlock-time constraints:\n\n`\u00a0\u00a0\u00a0enum\u00a0{\u00a0nMedianTimeSpan=11\u00a0};`\\\n`\u00a0\u00a0\u00a0`\\\n`\u00a0\u00a0\u00a0int64_t\u00a0GetMedianTimePast(const\u00a0CBlockIndex*\u00a0pindex)`\\\n`\u00a0\u00a0\u00a0{`\\\n`\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0int64_t\u00a0pmedian[nMedianTimeSpan];`\\\n`\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0int64_t*\u00a0pbegin\u00a0=\u00a0&pmedian[nMedianTimeSpan];`\\\n`\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0int64_t*\u00a0pend\u00a0=\u00a0&pmedian[nMedianTimeSpan];`\\\n`\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0for\u00a0(int\u00a0i\u00a0=\u00a00;\u00a0i\u00a0<\u00a0nMedianTimeSpan\u00a0&&\u00a0pindex;\u00a0i++,\u00a0pindex\u00a0=\u00a0pindex->pprev)`\\\n`\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0*(--pbegin)\u00a0=\u00a0pindex->GetBlockTime();`\\\n`\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0std::sort(pbegin,\u00a0pend);`\\\n`\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0return\u00a0pbegin[(pend\u00a0-\u00a0pbegin)/2];`\\\n`\u00a0\u00a0\u00a0}`\n\nLock-time constraints are checked by the consensus method IsFinalTx().\nThis method takes the block time as one parameter. This BIP proposes\nthat after activation calls to IsFinalTx() within consensus code use the\nreturn value of \\`GetMedianTimePast(pindexPrev)\\` instead.\n\nThe new rule applies to all transactions, including the coinbase\ntransaction.\n\nA reference implementation of this proposal is provided by the following\npull request:\n\n<https://github.com/bitcoin/bitcoin/pull/6566>"
    },
    {
      "header": "Deployment",
      "content": "This BIP is to be deployed by \\\"versionbits\\\" BIP9 using bit 0.\n\nFor Bitcoin **mainnet**, the BIP9 **starttime** will be midnight 1st May\n2016 UTC (Epoch timestamp 1462060800) and BIP9 **timeout** will be\nmidnight 1st May 2017 UTC (Epoch timestamp 1493596800).\n\nFor Bitcoin **testnet**, the BIP9 **starttime** will be midnight 1st\nMarch 2016 UTC (Epoch timestamp 1456790400) and BIP9 **timeout** will be\nmidnight 1st May 2017 UTC (Epoch timestamp 1493596800).\n\nThis BIP must be deployed simultaneously with BIP68 and BIP112 using the\nsame deployment mechanism."
    },
    {
      "header": "Acknowledgements",
      "content": "Mark Friedenbach for designing and authoring the reference\nimplementation of this BIP.\n\nThanks go to Gregory Maxwell who came up with the original idea, in"
    },
    {
      "header": "bitcoin-wizards on 2013-07-16.",
      "content": "Thomas Kerin authored this BIP document."
    },
    {
      "header": "Compatibility",
      "content": "Transactions generated using time-based lock-time will take\napproximately an hour longer to confirm than would be expected under the\nold rules. This is not known to introduce any compatibility concerns\nwith existing protocols."
    },
    {
      "header": "References",
      "content": "[BIP9:\nVersionbits](https://github.com/bitcoin/bips/blob/master/bip-0009.mediawiki)\n\n[BIP65:\nOP_CHECKLOCKTIMEVERIFY](https://github.com/bitcoin/bips/blob/master/bip-0065.mediawiki)\n\n[BIP68: Consensus-enforced transaction replacement signaled via sequence\nnumbers](https://github.com/bitcoin/bips/blob/master/bip-0068.mediawiki)\n\n[BIP112:\nCHECKSEQUENCEVERIFY](https://github.com/bitcoin/bips/blob/master/bip-0112.mediawiki)\n\n[Softfork deployment\nconsiderations](http://lists.linuxfoundation.org/pipermail/bitcoin-dev/2015-August/010396.html)\n\n[Version bits](https://gist.github.com/sipa/bf69659f43e763540550)"
    },
    {
      "header": "Copyright",
      "content": "This document is placed in the public domain."
    }
  ]
}