{
  "BIP": "49",
  "Layer": "Applications",
  "Title": "Derivation scheme for P2WPKH-nested-in-P2SH based accounts",
  "Author": "Daniel Weigl <DanielWeigl@gmx.at>",
  "Comments-Summary": "No comments yet.",
  "Comments-URI": "https://github.com/bitcoin/bips/wiki/Comments:BIP-0049",
  "Status": "Final",
  "Type": "Informational",
  "Created": "2016-05-19",
  "License": "PD",
  "sections": [
    {
      "header": "Abstract",
      "content": "This BIP defines the derivation scheme for HD wallets using the\nP2WPKH-nested-in-P2SH ([BIP 141](bip-0141.mediawiki \"wikilink\"))\nserialization format for segregated witness transactions."
    },
    {
      "header": "Motivation",
      "content": "With the usage of P2WPKH-nested-in-P2SH ([BIP\n141](bip-0141.mediawiki#p2wpkh-nested-in-bip16-p2sh \"wikilink\"))\ntransactions it is necessary to have a common derivation scheme. It\nallows the user to use different HD wallets with the same masterseed\nand/or a single account seamlessly.\n\nThus the user needs to create dedicated segregated witness accounts,\nwhich ensures that only wallets compatible with this BIP will detect the\naccounts and handle them appropriately."
    },
    {
      "header": "Considerations",
      "content": "Two generally different approaches are possible for current BIP44\ncapable wallets:\n\n1\\) Allow the user to use the same account(s) that they already use, but\nadd segregated witness encoded addresses to it.\n\n1.1) Use the same public keys as defined in BIP44, but in addition to\nthe normal P2PKH address also derive the P2SH address from it.\n\n1.2) Use the same account root, but branch off and derive different\nexternal and internal chain roots to derive dedicated public keys for\nthe segregated witness addresses.\n\n2\\) Create dedicated accounts used only for segregated witness\naddresses.\n\nThe solutions from point 1 have a common disadvantage: if a user\nimports/recovers a BIP49-compatible wallet masterseed into/in a\nnon-BIP49-compatible wallet, the account might show up but also it might\nmiss some UTXOs.\n\nTherefore this BIP uses solution 2, which fails in a more visible way.\nEither the account shows up or not at all. The user does not have to\ncheck his balance after using the same seed in different wallets."
    },
    {
      "header": "Specifications",
      "content": "This BIP defines the two needed steps to derive multiple deterministic\naddresses based on a [BIP 32](bip-0032.mediawiki \"wikilink\") root\naccount."
    },
    {
      "header": "Public key derivation {#public_key_derivation}",
      "content": "To derive a public key from the root account, this BIP uses the same\naccount-structure as defined in [BIP 44](bip-0044.mediawiki \"wikilink\"),\nbut only uses a different purpose value to indicate the different\ntransaction serialization method.\n\nm / purpose' / coin_type' / account' / change / address_index\n\nFor the \\`purpose\\`-path level it uses \\`49\\'\\`. The rest of the levels\nare used as defined in BIP44."
    },
    {
      "header": "Address derivation {#address_derivation}",
      "content": "To derive the P2SH address from the above calculated public key, we use\nthe encapsulation defined in [BIP\n141](bip-0141.mediawiki#p2wpkh-nested-in-bip16-p2sh \"wikilink\"):\n\n`\u00a0\u00a0\u00a0witness:\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0``<signature>`{=html}`\u00a0``<pubkey>`{=html}\\\n`\u00a0\u00a0\u00a0scriptSig:\u00a0\u00a0\u00a0\u00a0<0\u00a0<20-byte-key-hash>>`\\\n`\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0(0x160014{20-byte-key-hash})`\\\n`\u00a0\u00a0\u00a0scriptPubKey:\u00a0HASH160\u00a0<20-byte-script-hash>\u00a0EQUAL`\\\n`\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0(0xA914{20-byte-script-hash}87)`"
    },
    {
      "header": "Extended Key Version {#extended_key_version}",
      "content": "When serializing extended keys, this scheme uses alternate version\nbytes. Extended public keys use `0x049d7cb2` to produce a \\\"ypub\\\"\nprefix, and private keys use `0x049d7878` to produce a \\\"yprv\\\" prefix.\nTestnet uses `0x044a5262` \\\"upub\\\" and `0x044a4e28` \\\"uprv.\\\"\n\nAdditional registered version bytes are listed in\n[SLIP-0132](https://github.com/satoshilabs/slips/blob/master/slip-0132.md \"wikilink\")."
    },
    {
      "header": "Backwards Compatibility {#backwards_compatibility}",
      "content": "This BIP is not backwards compatible by design as described under\n[considerations](#considerations \"wikilink\"). An incompatible wallet\nwill not discover accounts at all and the user will notice that\nsomething is wrong."
    },
    {
      "header": "Test vectors {#test_vectors}",
      "content": "masterseedWords = abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about\nmasterseed = uprv8tXDerPXZ1QsVNjUJWTurs9kA1KGfKUAts74GCkcXtU8GwnH33GDRbNJpEqTvipfCyycARtQJhmdfWf8oKt41X9LL1zeD2pLsWmxEk3VAwd (testnet)\n\n// Account 0, root = m/49'/1'/0'\naccount0Xpriv = uprv91G7gZkzehuMVxDJTYE6tLivdF8e4rvzSu1LFfKw3b2Qx1Aj8vpoFnHdfUZ3hmi9jsvPifmZ24RTN2KhwB8BfMLTVqaBReibyaFFcTP1s9n (testnet)\naccount0Xpub = upub5EFU65HtV5TeiSHmZZm7FUffBGy8UKeqp7vw43jYbvZPpoVsgU93oac7Wk3u6moKegAEWtGNF8DehrnHtv21XXEMYRUocHqguyjknFHYfgY (testnet)\n\n// Account 0, first receiving private key = m/49'/1'/0'/0/0\naccount0recvPrivateKey = cULrpoZGXiuC19Uhvykx7NugygA3k86b3hmdCeyvHYQZSxojGyXJ\naccount0recvPrivateKeyHex = 0xc9bdb49cfbaedca21c4b1f3a7803c34636b1d7dc55a717132443fc3f4c5867e8\naccount0recvPublickKeyHex = 0x03a1af804ac108a8a51782198c2d034b28bf90c8803f5a53f76276fa69a4eae77f\n\n// Address derivation\nkeyhash = HASH160(account0recvPublickKeyHex) = 0x38971f73930f6c141d977ac4fd4a727c854935b3\nscriptSig = <0 <keyhash>> = 0x001438971f73930f6c141d977ac4fd4a727c854935b3\naddressBytes = HASH160(scriptSig) = 0x336caa13e08b96080a32b5d818d59b4ab3b36742\n\n// addressBytes base58check encoded for testnet\naddress = base58check(prefix | addressBytes) = 2Mww8dCYPUpKHofjgcXcBCEGmniw9CoaiD2 (testnet)"
    },
    {
      "header": "Reference",
      "content": "-   [BIP16 - Pay to Script Hash](bip-0016.mediawiki \"wikilink\")\n-   [BIP32 - Hierarchical Deterministic\nWallets](bip-0032.mediawiki \"wikilink\")\n-   [BIP43 - Purpose Field for Deterministic\nWallets](bip-0043.mediawiki \"wikilink\")\n-   [BIP44 - Multi-Account Hierarchy for Deterministic\nWallets](bip-0044.mediawiki \"wikilink\")\n-   [BIP141 - Segregated Witness (Consensus\nlayer)](bip-0141.mediawiki \"wikilink\")"
    },
    {
      "header": "Copyright",
      "content": "This document is placed in the public domain."
    }
  ]
}